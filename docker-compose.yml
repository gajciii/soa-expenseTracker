services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - '5672:5672'
      - '15672:15672'
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS:-guest}
    restart: unless-stopped
    networks:
      - soa-network

  soa-expense:
    build:
      context: ./soa-expense
      dockerfile: Dockerfile
    container_name: soa-expense
    ports:
      - '8000:8000'
    env_file:
      - ./soa-expense/.env
    environment:
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:8080}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE:-logs-exchange}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-logs-queue}
      - RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY:-logs.route}
    restart: unless-stopped
    networks:
      - soa-network

  soa-login:
    build:
      context: ./soa-login
      dockerfile: Dockerfile
    container_name: soa-login
    ports:
      - '8001:8001'
    env_file:
      - ./soa-login/.env
    environment:
      - PORT=8001
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:8080}
      - EXPENSE_SERVICE_URL=http://soa-expense:8000
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE:-logs-exchange}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-logs-queue}
      - RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY:-logs.route}
    restart: unless-stopped
    networks:
      - soa-network
    depends_on:
      - soa-expense
      - rabbitmq

  soa-notification:
    build:
      context: ./soa-notification
      dockerfile: Dockerfile
    container_name: soa-notification
    ports:
      - '3001:3000'
    env_file:
      - ./soa-notification/.env
    environment:
      - APP_PORT=3000
      - AUTH_SERVICE_URL=http://soa-login:8001
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:8080}
    restart: unless-stopped
    networks:
      - soa-network
    depends_on:
      - soa-login

  soa-category-budget:
    build:
      context: ./soa-category-budget
      dockerfile: Dockerfile
    container_name: soa-category-budget
    ports:
      - '8002:8001'
    env_file:
      - ./soa-category-budget/.env
    environment:
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:8080,http://127.0.0.1:3000,http://127.0.0.1:5173,http://127.0.0.1:8080}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE:-logs-exchange}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-logs-queue}
      - RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY:-logs.route}
    restart: unless-stopped
    networks:
      - soa-network
    depends_on:
      - soa-login
      - rabbitmq

  soa-analytics:
    build:
      context: ./soa-analytics
      dockerfile: Dockerfile
    container_name: soa-analytics
    ports:
      - '8003:8003'
    env_file:
      - ./soa-analytics/.env
    environment:
      - PORT=8003
      - CATEGORY_BUDGET_URL=http://soa-category-budget:8001
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:8080,http://127.0.0.1:3000,http://127.0.0.1:5173,http://127.0.0.1:8080}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE:-logs-exchange}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-logs-queue}
      - RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY:-logs.route}
    restart: unless-stopped
    networks:
      - soa-network
    depends_on:
      - soa-category-budget
      - soa-login
      - rabbitmq

  soa-subscription:
    build:
      context: ./soa-subscription
      dockerfile: Dockerfile
    container_name: soa-subscription
    ports:
      - '3005:3005'
    env_file:
      - ./soa-subscription/.env
    environment:
      - APP_PORT=3005
      - EXPENSE_SERVICE_URL=http://soa-expense:8000
      - NOTIFICATION_SERVICE_URL=http://soa-notification:3001
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:8080}
    restart: unless-stopped
    networks:
      - soa-network
    depends_on:
      - soa-login
      - soa-notification

  soa-expense-shared:
    build:
      context: ./soa-shared-expenses
      dockerfile: Dockerfile
    container_name: soa-expense-shared
    volumes:
      - ./soa-shared-expenses/src/main/resources/firestore.json:/app/firestore.json:ro
    ports:
      - '8081:8080'
    environment:
      - PORT=8080
      - GOOGLE_APPLICATION_CREDENTIALS=/app/firestore.json
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE:-logs-exchange}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-logs-queue}
      - RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY:-logs.route}
    restart: unless-stopped
    networks:
      - soa-network

  soa-logs:
    build:
      context: ./soa-logs
      dockerfile: Dockerfile
    container_name: soa-logs
    ports:
      - '8010:8010'
    environment:
      - LOG_DB_PATH=/app/logs.db
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE:-logs-exchange}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-logs-queue}
      - RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY:-logs.route}
      - APP_PORT=8010
    restart: unless-stopped
    networks:
      - soa-network
    depends_on:
      - rabbitmq


networks:
  soa-network:
    driver: bridge
